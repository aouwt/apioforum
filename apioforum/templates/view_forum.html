{% extends 'base.html' %}
{% from 'common.html' import ts, tag, disp_user, post_url %}
{% block header %}<h1>{% block title %}apioforum{%endblock%}</h1>{%endblock%}
{%block content%}
<p>welcome to the apioforum</p>
<p>forum rules: do not be a bad person. do not do bad things.</p>
{% if g.user %}
<p><a class="actionbutton" href="{{url_for('forum.create_thread')}}">create new thread</a></p>
{% else %}
<p>please log in to create a new thread</p>
{% endif %}
<div class="thread-list">
	{%for thread in threads%}
		<div class="thread-listing">
			<div class="thread-listing-main">
				<div class="thread-listing-title">
					<a href="{{url_for('thread.view_thread',thread_id=thread.id)}}">
						{{- thread.title -}}
					</a>
				</div>
				<div class="thread-listing-tags">
					{% for the_tag in thread_tags[thread.id] %}
						{{tag(the_tag)}}
					{% endfor %}
				</div>
				<div class="thread-listing-creation">
					<div class="thread-listing-creator">
						{{ disp_user(thread.creator) }} 
					</div>
					{{ ts(thread.created) }}
				</div>
			</div>
			{% if preview_post[thread.id] %}
				<div class="thread-preview">
					{{ disp_user(preview_post[thread.id].author) }}
					<span class="thread-preview-ts">
						{{ ts(preview_post[thread.id].created) }}
					</span>
					<span class="thread-preview-post">
						<a href="{{post_url(preview_post[thread.id])}}">
							{{ preview_post[thread.id].content[:500]|e }}
						</a>
					</span>
				</div>
			{% endif %}
			{% if thread_polls[thread.id] %}
				{% set poll = thread_polls[thread.id] %}
				{% set total_votes = poll.total_votes %}
				{% set n = namespace() %}
				{% set n.runningtotal = 0 %}

				<div class="thread-vote-summary">
				<svg width="100%" height="15px" xmlns="http://www.w3.org/2000/svg">
				{% if total_votes == 0 %}
					<text text-anchor="middle" dominant-baseline="middle" x="11%" y="55%" fill="black" style="font-size:15px">no votes</text>
				{% else %}
					{% for opt in poll.options %}
					    {% set opt_count = opt.num or 0 %}
					    {% set colour = (loop.count|string + opt.text)|gen_colour %}
					    {% if opt_count != 0 %}
							{% set percentage = 100*(opt_count/total_votes) %}
							{# todo: do this in css somehow #}
							{% if opt.text|length > 10 %}
								{% set opt_text = opt.text[:7] + "..." %}
							{% else %}
								{% set opt_text = opt.text %}
							{% endif %}
							<rect y="0" height="100%" x="{{n.runningtotal}}%" width="{{percentage}}%" stroke="black" fill="{{colour}}" />
							<text text-anchor="middle" dominant-baseline="middle" y="55%" fill="black" style="font-size:15px" x="{{n.runningtotal+(percentage/2)}}%">
								{{opt_text}}: {{opt_count}}
							</text>
							{% set n.runningtotal = n.runningtotal + percentage %}
						{% endif %}
					{%  endfor %}
				{% endif %}
				<desc>
					poll: {{poll.title}}
					{% for opt in poll.options %}
					option "{{opt.text}}": {{opt.num or 0}} votes
					{% endfor %}
					total votes: {{total_votes}}
				</desc>
				</svg>
				</div>
			{% endif %}
		</div>
	{%endfor%}
</div>
{%endblock%}
